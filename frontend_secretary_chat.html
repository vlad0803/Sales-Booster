<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Secretary Chat</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            padding: 24px;
            display: flex;
            gap: 32px;
        }
        .main-panel {
            flex: 2;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        .side-panel {
            flex: 1;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 1px 4px #0001;
            padding: 24px;
            height: fit-content;
            min-width: 260px;
            max-width: 350px;
        }
        h2 { text-align: center; }
        .chat-box {
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            padding: 12px;
            margin-bottom: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        .msg { margin: 8px 0; }
        .msg.user { text-align: right; color: #1976d2; }
        .msg.bot { text-align: left; color: #333; }
        .input-row { display: flex; gap: 8px; }
        input, button { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { background: #1976d2; color: #fff; cursor: pointer; }
        button:disabled { background: #aaa; }
        .section { margin-bottom: 18px; }
        .success { color: green; }
        .error { color: #b71c1c; }
        .recommendation-list { margin: 8px 0 8px 16px; }
        .side-panel h3 { text-align: center; margin-top: 0; }
        @media (max-width: 900px) {
            .container { flex-direction: column; max-width: 98vw; gap: 0; padding: 8px; }
            .side-panel { max-width: 100%; margin-top: 24px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-panel">
        <h2>AI Secretary Chat</h2>
        <div class="chat-box" id="chatBox"></div>
        <form id="chatForm" autocomplete="off" class="section">
            <div class="input-row">
                <input type="text" id="chatInput" placeholder="Type your message..." required />
                <button type="submit">Send</button>
            </div>
        </form>
        <!-- Group selector removed: all actions are now chat-based only -->
    </div>
    <div class="side-panel">
        <h3>Check Employee Level</h3>
        <div class="input-row">
            <input type="number" id="employeeIdInput" placeholder="Employee ID" min="1" />
            <button id="checkGradeBtn">Check Level</button>
        </div>
        <div id="gradeResult"></div>
    </div>
</div>
<script>
const API_URL = 'http://localhost:1919';
const chatBox = document.getElementById('chatBox');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
// Group selector elements removed

// State
let state = {
    step: 'goal', // goal, recs, style, perf, message, review
    lastGoal: '',
    lastHorizon: 30,
    recommendations: [],
    selectedRecs: [],
    style: 'friendly',
    performance_level: 'medium',
    message: '',
    manager_id: '',
    salesperson_id: '',
    review_approved: false,
    lastGroupShown: ''
};
// Show group members when user types 'show group [group]'
async function showGroupMembers(group) {
    bot('Loading group members...');
    // Call backend to get group members (reuse /send_group_review with dummy message and no actual sending)
    const res = await fetch(API_URL + '/send_group_review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ group, review_text: '[preview only]' })
    }).then(r => r.json());
    if (res && res.results && res.results.length) {
        let list = res.results.map(e => `${e.name || ''} (ID: ${e.salesperson_id})`).join('<br>');
        bot(`<b>Members in group <i>${group}</i>:</b><br>${list}`);
    } else {
        bot('No members found in this group.');
    }
}

function addMsg(text, sender) {
    const div = document.createElement('div');
    div.className = 'msg ' + sender;
    div.innerHTML = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function bot(text) { addMsg(text, 'bot'); }
function user(text) { addMsg(text, 'user'); }

function resetChat() {
    chatBox.innerHTML = '';
    state = { step: 'goal', lastGoal: '', lastHorizon: 30, recommendations: [], selectedRecs: [], style: 'friendly', performance_level: 'medium', message: '', manager_id: '', salesperson_id: '', review_approved: false };
    bot('<b>Welcome!</b> You can type <span style="color:#1976d2">restart</span> at any time to start over from the beginning.<br><span style="color:#555">This will clear the conversation and let you enter a new business objective from scratch.</span>');
    bot('Please enter your business objective.');
}

resetChat();

chatForm.onsubmit = async (e) => {
    e.preventDefault();
    const input = chatInput.value.trim();
    if (!input) return;
    user(input);
    chatInput.value = '';
    await handleInput(input);
};

async function handleInput(input) {
    if (input.trim().toLowerCase() === 'restart') {
        resetChat();
        return;
    }
    if (state.step === 'goal') {
        state.lastGoal = input;
        bot('Processing your objective...');
        // 1. Get summary
        try {
            bot('Loading business data summary...');
            const summaryRes = await fetch(API_URL + '/data_summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ goal: state.lastGoal, horizon: state.lastHorizon })
            }).then(r => r.json());
            if (summaryRes && summaryRes.ai_summary) {
                bot('<b>Business Data Summary (AI):</b><br><div style="white-space:pre-line;">' + summaryRes.ai_summary + '</div>');
            } else {
                bot('<span style="color:red">No summary available.</span>');
            }
        } catch (e) {
            bot('<span style="color:#b71c1c">Could not load data summary.</span>');
        }
        // 2. Get recommendations
        bot('Generating recommendations...');
        const recRes = await fetch(API_URL + '/recommendations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ goal: state.lastGoal, horizon: state.lastHorizon })
        }).then(r => r.json());
        state.recommendations = recRes.recommendations || [];
        if (!state.recommendations.length) {
            bot('No recommendations found. Please try another objective.');
            state.step = 'goal';
            return;
        }
        let recList = '<b>Available recommendations:</b><div class="recommendation-list">';
        state.recommendations.forEach((rec, i) => {
            recList += `<div>${i+1}. <b>${rec.title}</b><br><span style='font-size:13px;'>${rec.explanation}</span></div>`;
        });
        recList += '</div>';
        bot(recList + 'Reply with the numbers of the recommendations you want (e.g. 1,3).');
        state.step = 'recs';
        return;
    }
    if (state.step === 'recs') {
        // Parse selection
        const nums = input.split(',').map(x => parseInt(x.trim())-1).filter(x => !isNaN(x) && x >= 0 && x < state.recommendations.length);
        if (!nums.length) {
            bot('Please reply with valid numbers separated by commas (e.g. 1,2).');
            return;
        }
        state.selectedRecs = nums;
    bot('Now specify the message style (friendly, professional, motivational) and performance level (high, medium, low, all) in one line, e.g.: style: motivational, performance: high or performance: all');
        state.step = 'style_perf';
        return;
    }
    if (state.step === 'style_perf') {
        // Parse style and performance
        let styleMatch = input.match(/style\s*:\s*(friendly|professional|motivational)/i);
        let perfMatch = input.match(/performance\s*:\s*(high|medium|low|all)/i);
        if (styleMatch) state.style = styleMatch[1].toLowerCase();
        if (perfMatch) state.performance_level = perfMatch[1].toLowerCase();
        if (!styleMatch || !perfMatch) {
            bot('Please specify both style and performance, e.g.: style: professional, performance: low or performance: all');
            return;
        }
        bot('Generating team message...');
        // Compose message
        const msgRes = await fetch(API_URL + '/compose_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ goal: state.lastGoal, horizon: state.lastHorizon, selected: state.selectedRecs, style: state.style, performance_level: state.performance_level })
        }).then(r => r.json());
        state.message = msgRes.message;
    bot('<b>Team Message:</b><br><pre>' + state.message + '</pre>');
    // Group selector removed: nothing to show or set
    bot('Type "accept" to approve for one, "accept group" to send to the group matching the selected performance, "redo" to regenerate, or "manual" for a custom message.');
    state.step = 'review';
    return;
    }
    if (state.step === 'review') {
        // Allow user to go back to message generation (style/performance selection)
        if (input.toLowerCase() === 'back' || input.toLowerCase() === 'restart message') {
            bot('You can now select a different style and performance (e.g. style: professional, performance: low or performance: all)');
            state.step = 'style_perf';
            return;
        }
        if (input.toLowerCase() === 'accept') {
            bot('Please enter your manager ID and salesperson ID separated by comma (e.g. 1,2):');
            state.review_approved = true;
            state.step = 'ids';
            return;
        }
        // Accept group: send to selected group directly
        if (input.toLowerCase().startsWith('accept group')) {
            // Use the last selected performance_level as group
            let group = state.performance_level || 'high';
            bot(`Sending message to ${group} group...`);
            // Send to group
            const res = await fetch(API_URL + '/send_group_review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group, review_text: state.message })
            }).then(r => r.json());
            bot('<span class="success">Message sent to group!</span> Type "back" to generate a new message with a different style/group, or "restart" to start a new conversation.');
            // Show group members after sending
            if (res && res.results && res.results.length) {
                let list = res.results.map(e => `${e.name || ''} (ID: ${e.salesperson_id})`).join('<br>');
                bot(`<b>Members in group <i>${group}</i>:</b><br>${list}`);
            } else {
                bot('No members found in this group.');
            }
            state.step = 'done';
            return;
        }
        // Show group members: 'show group high', 'show group low', etc.
        if (input.toLowerCase().startsWith('show group')) {
            let group = 'high';
            const match = input.match(/show group\s+(low|medium|high|all)/i);
            if (match) group = match[1].toLowerCase();
            state.lastGroupShown = group;
            await showGroupMembers(group);
            return;
        }
        if (input.toLowerCase() === 'redo') {
            bot('Regenerating message. Please re-enter style and performance (e.g. style: friendly, performance: medium)');
            state.step = 'style_perf';
            return;
        }
        if (input.toLowerCase() === 'manual') {
            bot('Please write your custom message.');
            state.step = 'manual';
            return;
        }
        // Show full prompt for any unrecognized input
        bot('Type "accept" to approve for one, "accept group" to send to the group matching the selected performance, "redo" to regenerate, or "manual" for a custom message.');
        return;
    }
    if (state.step === 'manual') {
        state.message = input;
        bot('Choose how to send the message:<br>1️⃣ Type "one" to send to a single employee (with IDs)<br>2️⃣ Type "group" to send to a group (use selector below)');
        state.review_approved = true;
        state.step = 'choose_send_mode';
        return;
    }
    if (state.step === 'choose_send_mode') {
        if (input.trim().toLowerCase() === 'one') {
            bot('Please enter your manager ID and salesperson ID separated by comma (e.g. 1,2):');
            state.step = 'ids';
            return;
        } else if (input.trim().toLowerCase() === 'group') {
            groupSelector.style.display = '';
            bot('Select the group below and press "Send to Group".');
            state.step = 'wait_group_send';
            return;
        } else {
            bot('Type "one" for single employee or "group" for group send.');
            return;
        }
    }
    if (state.step === 'ids') {
        const ids = input.split(',').map(x => parseInt(x.trim()));
        if (ids.length !== 2 || ids.some(isNaN)) {
            bot('Please enter two valid numbers separated by comma (e.g. 1,2).');
            return;
        }
        state.manager_id = ids[0];
        state.salesperson_id = ids[1];
        bot('Sending review...');
        const res = await fetch(API_URL + '/send_review', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ manager_id: state.manager_id, salesperson_id: state.salesperson_id, review_text: state.message })
        }).then(r => r.json());
        bot('<span class="success">Review sent and saved!</span> Type "restart" to start a new conversation.');
        state.step = 'done';
        return;
    }
    if (state.step === 'done') {
        // Allow user to go back to message generation (style/performance selection) from done state
        if (input.toLowerCase() === 'back' || input.toLowerCase() === 'restart message') {
            bot('You can now select a different style and performance (e.g. style: professional, performance: low or performance: all)');
            state.step = 'style_perf';
            return;
        }
        if (input.toLowerCase() === 'restart') {
            resetChat();
            return;
        }
        bot('Type "restart" to start again, or "back" to generate a new message with a different style/group.');
        return;
    }
}
// Employee grade panel logic
const employeeIdInput = document.getElementById('employeeIdInput');
const checkGradeBtn = document.getElementById('checkGradeBtn');
const gradeResult = document.getElementById('gradeResult');
checkGradeBtn.onclick = async () => {
    const empId = parseInt(employeeIdInput.value.trim());
    if (!empId) {
        gradeResult.innerHTML = '<span class="error">Please enter a valid ID!</span>';
        return;
    }
    gradeResult.innerHTML = 'Checking...';
    try {
        const res = await fetch(`${API_URL}/employee_grade_openai?employee_id=${empId}`)
            .then(r => r.json());
        if (res.grade) {
            let next = '';
            const autoSales = res.auto_sales || 0;
            const serviceSales = res.service_sales || 0;
            let toSilver = '';
            let toGold = '';
            let hasSilver = (autoSales >= 5 || serviceSales >= 3);
            let hasGold = (autoSales >= 10 || serviceSales >= 5);
            if (res.grade === 'bronze') {
                let carNeed = 5 - autoSales;
                let serviceNeed = 3 - serviceSales;
                if (carNeed > 0 && serviceNeed > 0) {
                    next = `To reach silver: you need ${carNeed} more car sales <b>or</b> ${serviceNeed} more service sales.`;
                } else if (carNeed > 0) {
                    next = `To reach silver: you need ${carNeed} more car sales.`;
                } else if (serviceNeed > 0) {
                    next = `To reach silver: you need ${serviceNeed} more service sales.`;
                } else {
                    next = '';
                }
            } else if (res.grade === 'silver') {
                let carNeed = 10 - autoSales;
                let serviceNeed = 5 - serviceSales;
                if (carNeed > 0 && serviceNeed > 0) {
                    next = `To reach gold: you need ${carNeed} more car sales <b>or</b> ${serviceNeed} more service sales.`;
                } else if (carNeed > 0) {
                    next = `To reach gold: you need ${carNeed} more car sales.`;
                } else if (serviceNeed > 0) {
                    next = `To reach gold: you need ${serviceNeed} more service sales.`;
                } else {
                    next = '';
                }
            } else {
                next = '';
            }
            gradeResult.innerHTML = `<b>Level:</b> <span style="color:#1976d2;text-transform:uppercase">${res.grade}</span><br>
                <b>Car sales:</b> ${res.auto_sales ?? '-'} &nbsp; <b>Service sales:</b> ${res.service_sales ?? '-'}<br>
                <span style=\"color:#555\">${next}</span>`;
        } else {
            gradeResult.innerHTML = '<span class="error">Could not determine the level.</span>';
        }
    } catch (e) {
        gradeResult.innerHTML = '<span class="error">Error while checking.</span>';
    }
};
</script>
</body>
</html>
